import{c as e}from"./createLucideIcon-DApH4y_Q.js";import{_ as t,j as n}from"./spline-DN92G9fQ.js";import{r}from"./react-vendor-C5CBPnGl.js";import{A as s}from"./arrow-left-D6ZoFILw.js";import{s as a,A as o}from"./index-DxFs0pY3.js";
/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const i=e("AlertCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]),l=e("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]),c=e("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]),d=e("ImagePlus",[["path",{d:"M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7",key:"31hg93"}],["line",{x1:"16",x2:"22",y1:"5",y2:"5",key:"ez7e4s"}],["line",{x1:"19",x2:"19",y1:"2",y2:"8",key:"1gkr8c"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]),u=e("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]),m=e("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]),g=e("Pin",[["line",{x1:"12",x2:"12",y1:"17",y2:"22",key:"1jrz49"}],["path",{d:"M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z",key:"13yl11"}]]),f=e("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]),h=e("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),p=e("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]),x=e("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),y="messages_cache_";
/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function v(e){try{const t=localStorage.getItem(y+e);if(t){const n=JSON.parse(t);if("1"!==n.version)return null;return Date.now()-n.timestamp>3e5?(localStorage.removeItem(y+e),null):n.messages||null}}catch(t){}return null}function b(e,t){try{const n={messages:t,timestamp:Date.now(),version:"1"};localStorage.setItem(y+e,JSON.stringify(n))}catch(n){}}const w="conversations_cache";function _(e){try{const t=sessionStorage.getItem(w);if(t){const n=JSON.parse(t);if("1"!==n.version||n.customerId!==e)return null;return Date.now()-n.timestamp>6e5?(sessionStorage.removeItem(w),null):n.conversations||null}}catch(t){}return null}function j(e){const[n,s]=r.useState(()=>{if("undefined"!=typeof window&&e){return _(e)||[]}return[]}),[o,i]=r.useState(()=>{if("undefined"!=typeof window&&e){const t=_(e);return!t||0===t.length}return!0}),l=r.useCallback((e,t)=>{s(n=>n.map(n=>n.id===e?{...n,unread_count_customer:t}:n))},[]),c=r.useCallback(async()=>{if(!e)return s([]),void i(!1);const{data:n,error:r}=await a.from("conversations").select("\n        *,\n        admin:profiles!conversations_admin_id_fkey(*)\n      ").eq("customer_id",e).order("last_message_at",{ascending:!1});if(!r&&n){const a=n;a.forEach((e,t)=>{e.admin});a.reduce((e,t)=>e+(t.unread_count_customer||0),0);s([...a]),function(e,t){try{const n={conversations:t,timestamp:Date.now(),version:"1",customerId:e};sessionStorage.setItem(w,JSON.stringify(n))}catch(r){}}(e,a),a.forEach(e=>{var n;(null==(n=e.admin)?void 0:n.avatar_url)&&t(async()=>{const{preloadAndCacheImage:e}=await Promise.resolve().then(()=>V);return{preloadAndCacheImage:e}},void 0).then(({preloadAndCacheImage:t})=>{t(e.admin.avatar_url)})})}i(!1)},[e]);return r.useEffect(()=>{if(!e)return s([]),void i(!1);const t=_(e);t&&t.length>0&&(s(t),i(!1)),c();const n=a.channel(`customer-conversations:${e}`).on("postgres_changes",{event:"*",schema:"public",table:"conversations",filter:`customer_id=eq.${e}`},e=>{const t=e.new;e.old;if("UPDATE"===e.eventType&&(null==t?void 0:t.id)){const e=t;return void s(t=>{const n=t.findIndex(t=>t.id===e.id);if(n>=0){const r=[...t],s=t[n].admin;r[n]={...e,admin:s};r.reduce((e,t)=>e+(t.unread_count_customer||0),0);return r}return t})}c()}).subscribe(e=>{});return()=>{n.unsubscribe()}},[e,c]),{conversations:n,loading:o,updateConversationUnreadCount:l,refetch:c}}function k(e){const[t,n]=r.useState(null),[s,o]=r.useState(!0);return r.useEffect(()=>{(async()=>{const{data:t,error:r}=await a.from("profiles").select("*").eq("id",e).maybeSingle();!r&&t&&n(t),o(!1)})();const t=a.channel(`profile:${e}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"profiles",filter:`id=eq.${e}`},e=>{n(e.new)}).subscribe();return()=>{t.unsubscribe()}},[e]),{profile:t,loading:s}}function N(e){r.useEffect(()=>{const t=async t=>{await a.from("profiles").update({is_online:t,last_seen:(new Date).toISOString()}).eq("id",e)};t(!0);const n=()=>{t(!document.hidden)},r=()=>{t(!1)};return document.addEventListener("visibilitychange",n),window.addEventListener("beforeunload",r),()=>{document.removeEventListener("visibilitychange",n),window.removeEventListener("beforeunload",r),t(!1)}},[e])}async function C(){try{const{data:e,error:t}=await a.from("profiles").select("id, name, is_admin").eq("is_admin",!0).limit(1).maybeSingle();if(t)return null;if(!e){const{data:e,error:t}=await a.from("profiles").select("id, name, is_admin, email").limit(10);if(t);else{((null==e?void 0:e.filter(e=>!0===e.is_admin))||[]).length}return null}return e.id}catch(e){return null}}async function F(e){var t,n,r,s,o,i;try{const{data:l,error:c}=await a.from("profiles").select("id").eq("id",e).maybeSingle();if(c)return null;if(!l){const{data:n,error:r}=await a.from("users").select("email, first_name, last_name, full_name").eq("id",e).maybeSingle();if(r)return null;const s=(null==n?void 0:n.full_name)||((null==n?void 0:n.first_name)&&(null==n?void 0:n.last_name)?`${n.first_name} ${n.last_name}`.trim():null)||(null==(t=null==n?void 0:n.email)?void 0:t.split("@")[0])||"User",{error:o}=await a.from("profiles").insert({id:e,name:s,avatar_url:"",is_admin:!1,is_online:!1});if(o)return null}const d=await C();if(!d)return null;const{data:u,error:m}=await a.from("conversations").select("*").eq("customer_id",e).eq("admin_id",d).maybeSingle();if(m&&"PGRST116"!==m.code)return null;if(u){const{data:e,error:t}=await a.from("profiles").select("*").eq("id",d).single();return t?null:e?{...u,admin:e}:null}const{data:g,error:f}=await a.from("conversations").insert({customer_id:e,admin_id:d,last_message:"",unread_count_admin:0,unread_count_customer:0}).select("*").single();if(f){if("23505"===f.code||"409"===f.code||"PGRST204"===f.code||(null==(n=f.message)?void 0:n.toLowerCase().includes("duplicate"))||(null==(r=f.message)?void 0:r.toLowerCase().includes("unique"))||(null==(s=f.message)?void 0:s.toLowerCase().includes("conflict"))||(null==(o=f.message)?void 0:o.toLowerCase().includes("already exists"))){const{data:t,error:n}=await a.from("conversations").select("*").eq("customer_id",e).eq("admin_id",d).maybeSingle();if(n)return null;if(t){const{data:e,error:n}=await a.from("profiles").select("*").eq("id",d).single();if(n)return null;if(e)return{...t,admin:e}}}return null}const{data:h}=await a.from("users").select("first_name").eq("id",e).maybeSingle(),p=(null==(i=null==h?void 0:h.first_name)?void 0:i.trim())||"",x=`Hi${p?` ${p},`:""} welcome to Elevate! ðŸ‘‹\n\nIf you have any questions, feel free to ask.\n\nHave suggestions or feedback? You can submit them here. We review everything and are always working to give you the best experience on Elevate.`,{error:y}=await a.from("messages").insert({conversation_id:g.id,sender_id:d,type:"text",content:x,status:"sent"});if(y);else{const e=x.split("\n")[0];await a.from("conversations").update({last_message:e,last_message_at:(new Date).toISOString(),last_message_sender_id:d,unread_count_customer:1}).eq("id",g.id)}const{data:v,error:b}=await a.from("profiles").select("*").eq("id",d).single();if(b)return null;if(v&&g){return{...g,admin:v}}return null}catch(l){return null}}function S(e){const[n,s]=r.useState([]),[o,i]=r.useState(!0),l=r.useRef(!1);return r.useEffect(()=>{if(!e)return s([]),void i(!1);const n=async()=>{l.current||i(!0);const{data:n,error:r}=await a.from("conversations").select("*").eq("admin_id",e);if(r)return s([]),i(!1),void(l.current=!0);if(!n||0===n.length)return s([]),i(!1),void(l.current=!0);const o=[...new Set(n.map(e=>e.customer_id))],c=n.map(e=>e.id),{data:d,error:u}=await a.from("profiles").select("*").in("id",o);if(u)return s([]),i(!1),void(l.current=!0);const{data:m,error:g}=await a.from("messages").select("conversation_id, created_at, sender_id").in("conversation_id",c).order("created_at",{ascending:!1}),f=new Map;if(m)for(const e of m){const t=n.find(t=>t.id===e.conversation_id);t&&e.sender_id===t.customer_id&&(f.has(e.conversation_id)||f.set(e.conversation_id,e.created_at))}const h=new Map((d||[]).map(e=>[e.id,e])),p=n.map(e=>({...e,customer:h.get(e.customer_id)||null,last_customer_message_at:f.get(e.id)||e.last_message_at})).filter(e=>null!==e.customer);p.forEach(e=>{var n;(null==(n=e.customer)?void 0:n.avatar_url)&&t(async()=>{const{preloadAndCacheImage:e}=await Promise.resolve().then(()=>V);return{preloadAndCacheImage:e}},void 0).then(({preloadAndCacheImage:t})=>{t(e.customer.avatar_url)})}),p.sort((e,t)=>{const n=f.has(e.id),r=f.has(t.id);if(n&&!r)return-1;if(!n&&r)return 1;const s=e.last_customer_message_at?new Date(e.last_customer_message_at).getTime():e.last_message_at?new Date(e.last_message_at).getTime():0;return(t.last_customer_message_at?new Date(t.last_customer_message_at).getTime():t.last_message_at?new Date(t.last_message_at).getTime():0)-s}),s(p),i(!1),l.current=!0};n();const r=a.channel(`admin-conversations:${e}`).on("postgres_changes",{event:"*",schema:"public",table:"conversations",filter:`admin_id=eq.${e}`},()=>{n()}).subscribe();return()=>{r.unsubscribe()}},[e]),{conversations:n,loading:o}}function E(e){const t=new Date(e),n=new Date,r=n.getTime()-t.getTime(),s=Math.floor(r/864e5);return 0===s?"Today":1===s?"Yesterday":s<7?t.toLocaleDateString("en-US",{weekday:"long"}):t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:t.getFullYear()!==n.getFullYear()?"numeric":void 0})}function I(e){const t=new Date(e),n=(new Date).getTime()-t.getTime(),r=Math.floor(n/864e5);return 0===r?t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}):1===r?"Yesterday":r<7?t.toLocaleDateString("en-US",{weekday:"short"}):t.toLocaleDateString("en-US",{month:"short",day:"numeric"})}const T=r.memo(function({conversation:e,otherUser:t,currentUserId:s,getSenderName:i,isLoading:l=!1,onMarkAsRead:c}){const{messages:d,loading:u,otherUserTyping:m,sendMessage:g,setTyping:f,markMessagesAsSeen:h}=function({conversationId:e,currentUserId:t}){const[n,s]=r.useState(()=>"undefined"!=typeof window&&v(e)||[]),[o,i]=r.useState(()=>{if("undefined"!=typeof window){const t=v(e);return!t||0===t.length}return!0}),[l,c]=r.useState(!1),d=r.useRef(null),u=r.useCallback(async()=>{if(e)try{const{data:t,error:n}=await a.from("messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});if(n)return void i(!1);if(t){const n=t;s(n),b(e,n)}}catch(t){}finally{i(!1)}else i(!1)},[e]);return r.useEffect(()=>{if(!e)return;const n=v(e);n&&n.length>0?(s(n),i(!1)):(s([]),i(!0)),u();const r=a.channel(`messages:${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},t=>{const n=t.new;s(t=>{if(t.some(e=>e.id===n.id))return t;const r=[...t,n];return b(e,r),r})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},t=>{const n=t.new;s(t=>{const r=t.map(e=>e.id===n.id?n:e);return b(e,r),r})}).subscribe(),o=a.channel(`typing:${e}`).on("broadcast",{event:"typing"},({payload:e})=>{e.userId!==t&&c(e.isTyping)}).subscribe();return d.current=o,()=>{r.unsubscribe(),o.unsubscribe()}},[e,t,u]),{messages:n,loading:o,otherUserTyping:l,sendMessage:r.useCallback(async(n,r,s)=>{const o=r?"image":"text",{data:i,error:l}=await a.from("messages").insert({conversation_id:e,sender_id:t,type:o,content:n||"",image_url:r||"",status:"sent",reply_to_id:(null==s?void 0:s.id)||null,reply_to_sender_name:(null==s?void 0:s.senderName)||"",reply_to_content:(null==s?void 0:s.content)||""}).select().single();if(l)return{data:null,error:l};if(i){const{data:r}=await a.from("conversations").select("customer_id, admin_id, unread_count_admin, unread_count_customer").eq("id",e).single();if(r){const s=r.customer_id===t;let o=n||"Sent an image";"Sent an image"!==o&&(o=o.replace(/\n/g," ").trim(),o.startsWith("Me: ")&&(o=o.substring(4).trim()),o.length>80&&(o=o.substring(0,80)+"..."));const i={last_message:o,last_message_at:(new Date).toISOString(),last_message_sender_id:t};if(s)i.unread_count_customer=0,i.unread_count_admin=(r.unread_count_admin||0)+1;else{i.unread_count_admin=0;const e=r.unread_count_customer||0;i.unread_count_customer=e+1}const{error:l}=await a.from("conversations").update(i).eq("id",e)}}return{data:i,error:null}},[e,t]),setTyping:r.useCallback(e=>{var n;null==(n=d.current)||n.send({type:"broadcast",event:"typing",payload:{userId:t,isTyping:e}})},[t]),markMessagesAsSeen:r.useCallback(async()=>{const{data:n}=await a.from("conversations").select("customer_id, admin_id").eq("id",e).single();if(n){const r=n.customer_id===t;await a.from("messages").update({status:"seen"}).eq("conversation_id",e).neq("sender_id",t).neq("status","seen");const s={};r?s.unread_count_customer=0:s.unread_count_admin=0;const{data:o,error:i}=await a.from("conversations").update(s).eq("id",e).select().single()}},[e,t])}}({conversationId:e.id,currentUserId:s}),{uploadImage:p,uploading:x}=function(){const[e,t]=r.useState(!1);return{uploadImage:async e=>{var n;t(!0);try{const t=new FormData;t.append("image",e);const r=await fetch("https://api.imgbb.com/1/upload?key=012774bd056a91a1055131cf67c1a486",{method:"POST",body:t});if(r.ok){const e=await r.json();if(null==(n=e.data)?void 0:n.url)return e.data.url}const s=new FileReader;return new Promise((t,n)=>{s.onerror=()=>{n(new Error("Failed to read image"))},s.onloadend=()=>{t(s.result)},s.readAsDataURL(e)})}catch(r){const t=new FileReader;return new Promise((n,r)=>{t.onerror=()=>{r(new Error("Failed to read image"))},t.onloadend=()=>{n(t.result)},t.readAsDataURL(e)})}finally{t(!1)}},uploading:e}}(),y=r.useRef(null),w=r.useRef(null),[_,j]=r.useState(null),k=r.useRef(null),N=r.useRef(!1),C=r.useRef(!0),F=r.useRef(!0),[S,I]=r.useState(!1),T=r.useRef({}),R=r.useMemo(()=>d.filter(e=>"image"===e.type&&e.image_url),[d]);r.useEffect(()=>{C.current=!0,F.current=!0,I(!1),T.current={}},[e.id]),r.useEffect(()=>{if(!u&&d.length>0){if(0===R.length)return void I(!0);R.every(e=>!0===T.current[e.id])&&I(!0)}else u||0!==d.length||I(!0)},[u,d.length,R]);const A=r.useCallback((e,t)=>{T.current[e]=t;R.every(e=>!0===T.current[e.id])&&!u&&I(!0)},[R,u]);r.useEffect(()=>{!u&&d.length>0&&y.current&&F.current&&S&&(y.current.scrollIntoView({behavior:C.current?"instant":"smooth"}),C.current&&(C.current=!1))},[u,d.length,e.id,S]),r.useEffect(()=>(N.current=!1,()=>{N.current=!1}),[e.id]),r.useEffect(()=>{d.length>0&&!N.current&&h().then(()=>{N.current=!0,c&&c(e.id)})},[e.id,d.length,h,c]),r.useEffect(()=>{if(d.length>0&&w.current){k.current&&clearTimeout(k.current);const t=w.current;return t.scrollHeight-t.scrollTop<=t.clientHeight+100&&(k.current=setTimeout(()=>{h().then(()=>{c&&c(e.id)})},2e3)),()=>{k.current&&clearTimeout(k.current)}}},[d.length,h,e.id,c]);const L=r.useCallback(e=>{j(e)},[]),D=r.useCallback(()=>{j(null)},[]),q=r.useCallback(e=>{const t=document.getElementById(`message-${e}`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("bg-neutral-700/30"),setTimeout(()=>{t.classList.remove("bg-neutral-700/30")},1500))},[]);return n.jsxs("div",{className:"flex-1 flex flex-col min-h-0 min-w-0 overflow-hidden",style:{backgroundColor:"#111111",height:"100%"},children:[n.jsx(U,{user:t,isTyping:m}),n.jsx("div",{ref:w,className:"flex-1 overflow-y-auto min-h-0",style:{backgroundColor:"#111111",scrollbarWidth:"thin",scrollbarColor:"rgba(75, 85, 99, 0.3) transparent",overflowY:"auto"},onScroll:()=>{if(w.current){const t=w.current,n=t.scrollHeight-t.scrollTop<=t.clientHeight+50;F.current=n,n&&d.length>0&&(k.current&&clearTimeout(k.current),h().then(()=>{c&&c(e.id)}))}},children:n.jsxs("div",{className:"py-2 lg:py-4 min-h-full flex flex-col justify-end",children:[u?n.jsx("div",{className:"flex-1 flex items-center justify-center",children:n.jsx(o,{text:"Loading messages..."})}):0===d.length?n.jsx("div",{className:"flex-1 flex items-center justify-center",children:n.jsxs("div",{className:"text-center px-4 lg:px-6",children:[n.jsx("div",{className:"w-16 h-16 lg:w-20 lg:h-20 mx-auto mb-4 lg:mb-5 rounded-xl lg:rounded-2xl flex items-center justify-center",style:{backgroundColor:"#1a1a1e",border:"1px solid rgba(75, 85, 99, 0.1)"},children:n.jsx("svg",{className:"w-8 h-8 lg:w-10 lg:h-10",style:{color:"#64748B"},fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})})}),n.jsx("p",{className:"text-xs lg:text-sm font-medium",style:{color:"#94A3B8"},children:"No messages yet"}),n.jsx("p",{className:"text-[10px] lg:text-xs mt-1",style:{color:"#64748B"},children:"Start the conversation by sending a message"})]})}):n.jsx("div",{className:"space-y-0.5 lg:space-y-1 px-2 lg:px-2 "+(S?"chat-content-ready":"chat-content-loading"),children:d.map((e,t)=>{const r=t>0?d[t-1]:null,a=new Date(e.created_at),o=r?new Date(r.created_at):null,l=!(o&&(c=a,u=o,c.getFullYear()===u.getFullYear()&&c.getMonth()===u.getMonth()&&c.getDate()===u.getDate()));var c,u;return n.jsxs("div",{children:[l&&n.jsx("div",{className:"flex items-center justify-center py-5",children:n.jsx("div",{className:"px-3 py-1.5 rounded-lg",style:{backgroundColor:"#1a1a1e",border:"1px solid rgba(75, 85, 99, 0.15)"},children:n.jsx("span",{className:"text-xs font-medium",style:{color:"#94A3B8"},children:E(e.created_at)})})}),n.jsx(O,{message:e,isOwn:e.sender_id===s,onReply:L,onScrollToMessage:q,senderName:i(e.sender_id),onImageLoad:A})]},e.id)})}),m&&n.jsx(Z,{}),n.jsx("div",{ref:y})]})}),n.jsx(M,{onSendMessage:async(t,n,r)=>{j(null),F.current=!0;try{let s;if(n&&(s=await p(n)||void 0,!s))throw new Error("Failed to upload image");const a=await g(t,s,r);if(null==a?void 0:a.error)throw a.error;c&&c(e.id)}catch(s){}},onTyping:f,disabled:x,replyTo:_,onCancelReply:D,otherUserName:t.name})]})});function R({file:e,onRemove:t}){const[s,a]=r.useState("");return r.useEffect(()=>{const t=URL.createObjectURL(e);return a(t),()=>{URL.revokeObjectURL(t)}},[e]),n.jsxs("div",{className:"relative inline-block",children:[n.jsx("img",{src:s,alt:"Upload preview",className:"w-20 h-20 object-cover rounded-lg",style:{border:"1px solid rgba(75, 85, 99, 0.2)"}}),n.jsx("button",{onClick:t,className:"absolute -top-2 -right-2 p-1 rounded-full transition-colors",style:{backgroundColor:"#1a1a1e",border:"1px solid rgba(75, 85, 99, 0.2)"},children:n.jsx(x,{className:"w-3.5 h-3.5",style:{color:"#F8FAFC"}})})]})}function A({replyTo:e,onCancel:t}){const r=e.content.length>80?e.content.substring(0,80)+"...":e.content;return n.jsx("div",{className:"animate-fade-in",children:n.jsxs("div",{className:"flex items-start gap-3 px-3 py-2 rounded-lg border-l-2",style:{backgroundColor:"#1a1a1e",borderColor:"#64748B"},children:[n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsxs("p",{className:"text-xs font-medium",style:{color:"#F8FAFC"},children:["Replying to ",e.senderName]}),n.jsx("p",{className:"text-xs truncate mt-0.5",style:{color:"#94A3B8"},children:r||"Image"})]}),n.jsx("button",{onClick:t,className:"shrink-0 p-1 rounded-full hover:brightness-110 transition-colors",style:{color:"#64748B"},children:n.jsx(x,{className:"w-4 h-4"})})]})})}const L=10485760,D=["image/jpeg","image/jpg","image/png","image/gif","image/webp"];function M({onSendMessage:e,onTyping:t,disabled:s,replyTo:a,onCancelReply:o,otherUserName:l}){const[c,u]=r.useState(""),[m,g]=r.useState(null),f=r.useRef(null),h=r.useRef(null),x=r.useRef(null),y=r.useRef(null),v=r.useRef(null);r.useEffect(()=>{const e=h.current;if(e){e.style.height="36px";const t=e.scrollHeight;t>36&&(e.style.height=`${Math.min(t,150)}px`)}},[c]),r.useEffect(()=>{a&&h.current&&h.current.focus()},[a]),r.useEffect(()=>{x.current&&(x.current.style.borderRadius="0"),y.current&&(y.current.style.borderRadius="0"),h.current&&(h.current.style.borderRadius="0")},[]);const b=()=>{!c.trim()&&!m||s||(e(c.trim(),m||void 0,a||void 0),u(""),g(null),t(!1),v.current&&clearTimeout(v.current))},w=r.useCallback(e=>{var t;const n=null==(t=e.target.files)?void 0:t[0];n&&D.includes(n.type)?(n.size>L||g(n),e.target.value=""):e.target.value=""},[]),_=c.trim()||m;return n.jsxs(n.Fragment,{children:[a&&o&&n.jsx("div",{className:"px-3 lg:px-4 pt-3",children:n.jsx(A,{replyTo:a,onCancel:o})}),m&&n.jsx("div",{className:"px-3 lg:px-4 py-2",children:n.jsxs("div",{className:"p-3 rounded-lg flex items-center gap-3",style:{backgroundColor:"rgba(26, 26, 30, 0.5)"},children:[n.jsx(R,{file:m,onRemove:()=>g(null)}),m.size>L&&n.jsxs("div",{className:"flex items-center gap-2 text-xs",style:{color:"#ef4444"},children:[n.jsx(i,{className:"w-4 h-4"}),n.jsx("span",{children:"File too large"})]})]})}),n.jsxs("form",{onSubmit:e=>{e.preventDefault(),b()},className:"flex gap-2 items-center safe-area-inset-bottom",style:{borderTop:"1px solid rgba(75, 85, 99, 0.2)",backgroundColor:"#111111",padding:"12px 16px"},children:[n.jsx("input",{type:"file",ref:f,onChange:w,accept:"image/*",className:"hidden"}),n.jsx("button",{ref:x,type:"button",onClick:()=>{var e;return null==(e=f.current)?void 0:e.click()},disabled:s,className:"shrink-0 hover:bg-transparent group h-8 w-8 flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed",style:{color:"#94A3B8",borderRadius:0},children:n.jsx(d,{className:"w-4 h-4 transition-transform duration-200 group-hover:scale-125"})}),n.jsx("textarea",{ref:h,value:c,onChange:e=>{u(e.target.value),t(!0),v.current&&clearTimeout(v.current),v.current=setTimeout(()=>{t(!1)},2e3)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),b())},placeholder:l?`Message @${l}`:"Send a message...",disabled:s,rows:1,maxLength:5e3,"aria-label":"Message input",className:"flex-1 px-4 py-2 text-sm focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed resize-none overflow-y-auto",style:{minHeight:"32px",maxHeight:"120px",color:"#F8FAFC",backgroundColor:"#1a1a1e",border:"1px solid rgba(75, 85, 99, 0.2)",borderRadius:0}}),n.jsx("button",{ref:y,type:"submit",disabled:!_||s,className:"shrink-0 h-8 w-8 flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed",style:_?{backgroundColor:"#F8FAFC",color:"#111111",borderRadius:0}:{backgroundColor:"rgba(148, 163, 184, 0.1)",color:"#94A3B8",borderRadius:0},children:n.jsx(p,{className:"w-4 h-4"})})]})]})}const q=`data:image/svg+xml;base64,${btoa('<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <defs>\n      <linearGradient id="avatarGradient" x1="0%" y1="0%" x2="100%" y2="100%">\n        <stop offset="0%" stop-color="#1e1e24"/>\n        <stop offset="100%" stop-color="#0f0f13"/>\n      </linearGradient>\n      <linearGradient id="avatarShine" x1="0%" y1="0%" x2="100%" y2="100%">\n        <stop offset="0%" stop-color="#64748B" stop-opacity="0.15"/>\n        <stop offset="100%" stop-color="#64748B" stop-opacity="0"/>\n      </linearGradient>\n    </defs>\n    <circle cx="20" cy="20" r="20" fill="url(#avatarGradient)"/>\n    <circle cx="20" cy="15" r="7" fill="#64748B" fill-opacity="0.8"/>\n    <path d="M8 32c0-5.523 4.477-10 10-10h4c5.523 0 10 4.477 10 10" stroke="#64748B" stroke-width="2.5" stroke-opacity="0.8" fill="none" stroke-linecap="round"/>\n    <circle cx="20" cy="20" r="20" fill="url(#avatarShine)"/>\n  </svg>')}`;btoa('<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <rect width="40" height="40" fill="#000000"/>\n    <g>\n      \x3c!-- Leftmost bar (shortest) --\x3e\n      <rect x="7" y="19" width="3" height="6" rx="1.5" fill="#FFFFFF"/>\n      \x3c!-- Second bar (medium) --\x3e\n      <rect x="12" y="16" width="3" height="12" rx="1.5" fill="#FFFFFF"/>\n      \x3c!-- Center bar (tallest) --\x3e\n      <rect x="17" y="8" width="3" height="24" rx="1.5" fill="#FFFFFF"/>\n      \x3c!-- Fourth bar (medium) --\x3e\n      <rect x="22" y="16" width="3" height="12" rx="1.5" fill="#FFFFFF"/>\n      \x3c!-- Rightmost bar (shortest) --\x3e\n      <rect x="27" y="19" width="3" height="6" rx="1.5" fill="#FFFFFF"/>\n    </g>\n  </svg>');const B="https://hlcpoqxzqgbghsadouef.supabase.co/storage/v1/object/public/avatars/pic/elevate%20solid%20white%20logo%20ver.jpeg";function U({user:e,isTyping:t,onBack:r,showBackButton:a}){return n.jsx("div",{className:"h-14 lg:h-16 px-3 lg:px-4 flex items-center justify-between min-w-0",style:{borderBottom:"1px solid rgba(75, 85, 99, 0.2)",backgroundColor:"#111111"},children:n.jsxs("div",{className:"flex items-center gap-2 lg:gap-3 min-w-0 flex-1",children:[a&&n.jsx("button",{onClick:r,className:"p-1.5 lg:p-2 -ml-1 lg:-ml-2 rounded-full hover:brightness-110 transition-colors lg:hidden",style:{color:"#64748B"},children:n.jsx(s,{className:"w-4 h-4 lg:w-5 lg:h-5"})}),n.jsx("div",{className:"relative flex-shrink-0",children:n.jsx("img",{src:e.is_admin?B:e.avatar_url||q,alt:e.name,className:"w-8 h-8 lg:w-10 lg:h-10 rounded-full object-cover default-avatar-shake",style:{backgroundColor:"#0f0f13"}})}),n.jsxs("div",{className:"min-w-0 flex-1",children:[n.jsx("h2",{className:"text-sm lg:text-base font-medium truncate",style:{color:"#F8FAFC"},children:e.name}),t&&n.jsx("p",{className:"text-[10px] lg:text-xs",style:{color:"#64748B"},children:"typing..."})]})]})})}function P({isOpen:e,onClose:t,imageUrl:s}){return r.useEffect(()=>{const n=e=>{"Escape"===e.key&&t()};return e&&(document.addEventListener("keydown",n),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",n),document.body.style.overflow=""}},[e,t]),e?n.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in",style:{backgroundColor:"rgba(0, 0, 0, 0.9)"},onClick:t,children:[n.jsxs("div",{className:"absolute top-4 right-4 flex items-center gap-2",children:[n.jsx("a",{href:s,download:!0,target:"_blank",rel:"noopener noreferrer",className:"p-2 rounded-full transition-colors",style:{backgroundColor:"#1a1a1e",color:"#F8FAFC"},onClick:e=>e.stopPropagation(),children:n.jsx(c,{className:"w-5 h-5"})}),n.jsx("button",{onClick:t,className:"p-2 rounded-full transition-colors",style:{backgroundColor:"#1a1a1e",color:"#F8FAFC"},children:n.jsx(x,{className:"w-5 h-5"})})]}),n.jsx("img",{src:s,alt:"Full size preview",className:"max-w-[90vw] max-h-[90vh] object-contain rounded-lg",onClick:e=>e.stopPropagation()})]}):null}const $=r.memo(function(){return r.useEffect(()=>{if(!document.getElementById("wave-hand-keyframes")){const e=document.createElement("style");e.id="wave-hand-keyframes",e.textContent="\n        @keyframes wave-hand {\n          0%, 100% {\n            transform: rotate(0deg);\n          }\n          10%, 30% {\n            transform: rotate(14deg);\n          }\n          20% {\n            transform: rotate(-8deg);\n          }\n          40%, 60% {\n            transform: rotate(0deg);\n          }\n          50% {\n            transform: rotate(10deg);\n          }\n          70% {\n            transform: rotate(0deg);\n          }\n          80% {\n            transform: rotate(-5deg);\n          }\n          90% {\n            transform: rotate(0deg);\n          }\n        }\n      ",document.head.appendChild(e)}},[]),n.jsx("span",{className:"inline-block",style:{display:"inline-block",transformOrigin:"70% 70%",animation:"wave-hand 1s ease-in-out infinite"},children:"ðŸ‘‹"})}),O=r.memo(function({message:e,isOwn:t,onReply:s,onScrollToMessage:a,senderName:o,onImageLoad:i}){const[c,d]=r.useState(!1),[u,m]=r.useState(!1),[g,h]=r.useState(!1),[p,x]=r.useState(!1);r.useEffect(()=>{if("image"===e.type&&e.image_url){const t=new Image;t.onload=()=>{x(!0),null==i||i(e.id,!0)},t.onerror=()=>{h(!0),null==i||i(e.id,!0)},t.src=e.image_url}else null==i||i(e.id,!0)},[e.id,e.type,e.image_url,i]);const y=e.reply_to_id&&(e.reply_to_sender_name||e.reply_to_content);return n.jsxs(n.Fragment,{children:[n.jsx("div",{id:`message-${e.id}`,className:`group flex ${t?"justify-end":"justify-start"} px-2 lg:px-4 py-0.5`,onMouseEnter:()=>d(!0),onMouseLeave:()=>d(!1),children:n.jsxs("div",{className:"flex items-center gap-1.5 lg:gap-2 max-w-[85%] lg:max-w-[70%] min-w-0 "+(t?"flex-row-reverse":"flex-row"),children:[n.jsxs("div",{className:"flex flex-col gap-1 min-w-0",children:[y&&n.jsxs("button",{onClick:()=>{e.reply_to_id&&a&&a(e.reply_to_id)},className:"text-left px-2 py-1.5 rounded-lg border-l-2 transition-colors "+(t?"ml-auto":"mr-auto"),style:{backgroundColor:"#1a1a1e",borderColor:"#64748B",color:"#F8FAFC"},children:[n.jsx("p",{className:"text-[10px] font-medium",style:{color:"#64748B"},children:e.reply_to_sender_name}),n.jsx("p",{className:"text-[10px] line-clamp-1",style:{color:"#94A3B8"},children:e.reply_to_content||"Image"})]}),n.jsxs("div",{className:"relative rounded-2xl overflow-hidden transition-all duration-200 min-w-0 "+("image"!==e.type||e.content?"":"p-0"),style:t?{backgroundColor:"#F8FAFC",color:"#111111"}:{backgroundColor:"#1a1a1e",color:"#F8FAFC"},children:["image"===e.type&&e.image_url&&n.jsx("div",{className:"relative "+(e.content?"px-4 pt-3":"p-0"),children:g?n.jsx("div",{className:"rounded-lg flex items-center justify-center "+(e.content?"mb-2":""),style:{width:"100%",maxWidth:"280px",height:"200px",backgroundColor:"#0f0f13"},children:n.jsx("p",{className:"text-xs",style:{color:"#64748B"},children:"Failed to load image"})}):n.jsxs(n.Fragment,{children:[!p&&n.jsx("div",{className:"chat-image-placeholder rounded-lg "+(e.content?"mb-2":""),style:{width:"280px",height:"200px",backgroundColor:"rgba(75, 85, 99, 0.15)"}}),n.jsx("img",{src:e.image_url,alt:"Shared image",className:`rounded-lg w-full max-w-[280px] lg:max-w-[280px] max-h-[300px] object-cover cursor-pointer hover:opacity-90 transition-opacity ${e.content?"mb-2":""} ${p?"chat-image-loaded":""}`,style:{display:p?"block":"none",border:"none",outline:"none"},onClick:()=>m(!0),onError:()=>h(!0),onLoad:()=>x(!0)})]})}),e.content&&n.jsx("div",{className:"flex items-center min-h-[1.5rem] "+("image"===e.type&&e.image_url?"px-4 pb-3":"px-4 py-3"),children:n.jsx("p",{className:"text-sm leading-relaxed whitespace-pre-wrap break-words w-full",children:e.content.split("ðŸ‘‹").map((e,t,r)=>t<r.length-1?n.jsxs("span",{children:[e,n.jsx($,{})]},t):n.jsx("span",{children:e},t))})})]}),n.jsx("span",{className:"text-[10px] px-1 "+(t?"text-right":"text-left"),style:{color:"#94A3B8"},children:(v=e.created_at,new Date(v).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}))})]}),n.jsxs("div",{className:"flex items-center gap-1 transition-opacity duration-200 "+(c?"opacity-100":"opacity-0"),children:[e.content&&n.jsx("button",{onClick:async()=>{if(e.content)try{await navigator.clipboard.writeText(e.content)}catch(t){}},className:"p-1.5 rounded-full hover:brightness-110 transition-colors",style:{color:"#64748B"},children:n.jsx(l,{className:"w-3.5 h-3.5"})}),n.jsx("button",{onClick:()=>{s&&s({id:e.id,senderName:o||"Unknown",content:e.content||("image"===e.type?"Image":"")})},className:"p-1.5 rounded-full hover:brightness-110 transition-colors",style:{color:"#64748B"},children:n.jsx(f,{className:"w-3.5 h-3.5"})})]})]})}),"image"===e.type&&e.image_url&&n.jsx(P,{isOpen:u,onClose:()=>m(!1),imageUrl:e.image_url})]});var v}),z="avatar_cache_";function H(e){try{const t=localStorage.getItem(z+e);if(t){const{data:e,version:n}=JSON.parse(t);if("1"===n)return e}}catch(t){}return null}async function Y(e){try{if(H(e))return;const t=await async function(e){try{const t=await fetch(e,{mode:"cors"}),n=await t.blob();return new Promise((e,t)=>{const r=new FileReader;r.onloadend=()=>e(r.result),r.onerror=t,r.readAsDataURL(n)})}catch(t){return null}}(e);t&&localStorage.setItem(z+e,JSON.stringify({data:t,version:"1",timestamp:Date.now()}))}catch(t){}}function G(e){if(!e)return;if(H(e))return;const t=new Image;t.crossOrigin="anonymous",t.loading="eager",t.fetchPriority="high",t.onload=()=>{Y(e).catch(()=>{})},t.onerror=()=>{},t.src=e}const V=Object.freeze(Object.defineProperty({__proto__:null,cacheImage:Y,getCachedImage:H,preloadAndCacheImage:G},Symbol.toStringTag,{value:"Module"})),W={sm:{container:"w-8 h-8"},md:{container:"w-10 h-10"},lg:{container:"w-12 h-12"}};function J({src:e,name:t,size:s="md",isOnline:a,showOnlineIndicator:o=!1,isAdmin:i=!1}){const[l,c]=r.useState(!1),[d,u]=r.useState(!1),[m,g]=r.useState(null),f=r.useRef(null),h=i?B:e||"",p=h&&""!==h.trim();r.useEffect(()=>{if(!p)return void u(!0);const e=H(h);if(!e){G(h),c(!1),u(!1);const e=function(e,t,n){const r=new Image;return r.onload=t,r.onerror=n,r.src=e,r}(h,()=>c(!0),()=>u(!0));return f.current=e,()=>{f.current&&(f.current.onload=null,f.current.onerror=null)}}g(e),c(!0),G(h)},[h,p]);const x=m||h,y=p&&(l||m)&&!d,v=q;return n.jsxs("div",{className:"relative flex-shrink-0",children:[n.jsxs("div",{className:`${W[s].container} rounded-full flex items-center justify-center overflow-hidden relative`,children:[n.jsx("img",{src:v,alt:t,className:`${W[s].container} rounded-full object-cover absolute inset-0 default-avatar-shake`,style:{opacity:y?0:1,transition:"opacity 0.2s ease-in-out"}}),p&&n.jsx("img",{src:x,alt:t,className:`${W[s].container} rounded-full object-cover absolute inset-0`,style:{opacity:y?1:0,transition:y&&!m?"opacity 0.15s ease-in-out":"none"},onLoad:()=>{m||c(!0)},onError:()=>u(!0),loading:"eager",decoding:"async",fetchpriority:"high"})]}),o&&n.jsx("span",{className:"absolute bottom-0 right-0 w-3.5 h-3.5 border-2 rounded-full z-10",style:{borderColor:"#111111",backgroundColor:a?"#10b981":"#64748B"}})]})}function K({x:e,y:t,onClose:s,onPin:a,isPinned:o=!1}){const i=r.useRef(null);return r.useEffect(()=>{const e=e=>{i.current&&!i.current.contains(e.target)&&s()},t=e=>{"Escape"===e.key&&s()};return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t)}},[s]),r.useEffect(()=>{if(i.current){const n=i.current,r=n.getBoundingClientRect(),s=window.innerWidth,a=window.innerHeight;r.right>s&&(n.style.left=e-r.width+"px"),r.bottom>a&&(n.style.top=t-r.height+"px")}},[e,t]),n.jsx("div",{ref:i,className:"fixed rounded-lg shadow-lg py-1 min-w-[200px] z-50",style:{left:e,top:t,backgroundColor:"#1a1a1e",border:"1px solid rgba(75, 85, 99, 0.2)"},children:n.jsxs("button",{onClick:()=>{null==a||a(),s()},className:"w-full flex items-center gap-3 px-4 py-2.5 text-left hover:brightness-110 transition-colors",style:{color:"#F8FAFC"},children:[n.jsx(g,{className:"w-4 h-4"}),n.jsx("span",{className:"text-sm",children:o?"Unpin":"Pin"})]})})}const X=r.memo(function({user:e,conversation:t,isActive:s,onClick:a,onPin:o,unreadCount:i,currentUserId:l}){const c=void 0!==i?i:t.unread_count_customer,[d,u]=r.useState(null),m=t.last_message?(()=>{let e=t.last_message.replace(/\n/g," ").trim();return e.startsWith("Me: ")&&(e=e.substring(4).trim()),l&&t.last_message_sender_id===l?"Me: "+e:e})():"No messages yet";return n.jsxs(n.Fragment,{children:[n.jsxs("button",{onClick:a,onContextMenu:e=>{e.preventDefault(),u({x:e.clientX,y:e.clientY})},className:"w-full flex items-center gap-2 lg:gap-3 px-3 lg:px-4 py-2 lg:py-3 transition-colors text-left "+(s?"":"hover:brightness-110"),style:s?{backgroundColor:"#0f0f13"}:{backgroundColor:"transparent"},children:[n.jsx(J,{src:e.avatar_url,name:e.name,size:"lg",isAdmin:e.is_admin}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[n.jsx("span",{className:"text-sm lg:text-base font-medium truncate",style:{color:"#F8FAFC"},children:e.name}),n.jsx("span",{className:"text-[10px] lg:text-xs flex-shrink-0 ml-2",style:{color:"#64748B"},children:I(t.last_message_at)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("p",{className:"text-xs lg:text-sm truncate pr-2",style:{color:"#94A3B8"},children:m}),c>0&&n.jsx("span",{className:"flex-shrink-0 min-w-[18px] lg:min-w-[20px] h-4 lg:h-5 px-1 lg:px-1.5 flex items-center justify-center text-[10px] lg:text-xs font-medium rounded-full",style:{backgroundColor:"#ef4444",color:"#FFFFFF"},children:c>99?"99+":c})]})]})]}),d&&n.jsx(K,{x:d.x,y:d.y,onClose:()=>u(null),onPin:()=>{null==o||o(t.id,!t.is_pinned)},isPinned:t.is_pinned})]})});function Z(){return n.jsx("div",{className:"flex items-center gap-1 px-4 py-2",children:n.jsxs("div",{className:"flex items-center gap-1 rounded-2xl px-4 py-3",style:{backgroundColor:"#1a1a1e"},children:[n.jsx("span",{className:"w-2 h-2 rounded-full animate-bounce",style:{backgroundColor:"#64748B",animationDelay:"0ms"}}),n.jsx("span",{className:"w-2 h-2 rounded-full animate-bounce",style:{backgroundColor:"#64748B",animationDelay:"150ms"}}),n.jsx("span",{className:"w-2 h-2 rounded-full animate-bounce",style:{backgroundColor:"#64748B",animationDelay:"300ms"}})]})})}function Q(e,t){let n=null;return function(...r){n&&clearTimeout(n),n=setTimeout(()=>{n=null,e(...r)},t)}}export{i as A,l as C,q as D,B as E,u as L,m as M,h as S,X as U,x as X,k as a,N as b,T as c,Q as d,F as e,S as f,H as g,p as h,C as i,G as p,j as u};
