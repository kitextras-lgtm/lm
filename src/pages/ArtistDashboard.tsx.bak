import React, { useEffect, useState, useRef, useMemo } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { Video, MapPin, Globe, Plus, Info, ChevronRight, ChevronDown, X, MessageSquare } from 'lucide-react';
import { SuggestionIcon, BugReportIcon, FeatureRequestIcon, OtherIcon } from '../components/FeedbackIcons';
import { SocialLinksForm } from '../components/SocialLinksForm';
import { ReferralSection } from '../components/ReferralSection';
import { DoorTransition } from '../components/DoorTransition';
import { MessagesPage } from './MessagesPage';
import { supabase, SUPABASE_URL, SUPABASE_ANON_KEY } from '../lib/supabase';
import { useCustomerConversations } from '../hooks/useChat';
import { ELEVATE_ADMIN_AVATAR_URL } from '../components/DefaultAvatar';
import { FeedbackModal } from '../components/FeedbackModal';
import { getCachedImage, preloadAndCacheImage } from '../utils/imageCache';
import { useUserProfile } from '../contexts/UserProfileContext';
import { useTheme } from '../contexts/ThemeContext';
import { AnnouncementBanner } from '../components/AnnouncementBanner';
import { CollapsibleSidebar } from '../components/CollapsibleSidebar';
import { MobileBottomNav } from '../components/MobileBottomNav';
import { ProfileView } from '../components/ProfileView';
import { SettingsView } from '../components/SettingsView';

function YouTubeIcon({ isHovered, backgroundTheme }: { isHovered: boolean; backgroundTheme?: 'light' | 'grey' | 'dark' }) {
  return (
    <div className="cursor-pointer flex items-center justify-center">
      <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 sm:w-6 sm:h-6">
        <rect 
          x="8" 
          y="12" 
          width="32" 
          height="24" 
          rx="6" 
          stroke={isHovered ? "#FF0000" : (backgroundTheme === 'light' ? '#94A3B8' : '#94A3B8')} 
          strokeWidth="2.5" 
          fill="none"
          style={{
            transition: "stroke 0.3s ease-in-out",
          }}
        />
        <path
          d="M20 18L32 24L20 30V18Z"
          stroke={isHovered ? "#FF0000" : (backgroundTheme === 'light' ? '#94A3B8' : '#94A3B8')}
          strokeWidth="2.5"
          strokeLinejoin="round"
          fill={isHovered ? "#FF0000" : (backgroundTheme === 'light' ? '#94A3B8' : '#94A3B8')}
          style={{
            transform: isHovered ? "scale(1.15)" : "scale(1)",
            transformOrigin: "24px 24px",
            transition: "transform 0.3s ease-in-out, stroke 0.3s ease-in-out, fill 0.3s ease-in-out",
          }}
        />
      </svg>
    </div>
  );
}

function TikTokIcon({ isHovered, backgroundTheme }: { isHovered: boolean; backgroundTheme?: 'light' | 'grey' | 'dark' }) {
  const notePath = "M32 8V28C32 34.6 26.6 40 20 40C13.4 40 8 34.6 8 28C8 21.4 13.4 16 20 16V22C16.7 22 14 24.7 14 28C14 31.3 16.7 34 20 34C23.3 34 26 31.3 26 28V8H32Z";
  const wavePath = "M32 8C32 8 36 9 38 12C40 15 40 18 40 18";

  return (
    <div className="cursor-pointer flex items-center justify-center" style={{ overflow: 'visible' }}>
      <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 sm:w-6 sm:h-6" style={{ overflow: 'visible' }}>
        <g
          style={{
            opacity: isHovered ? 0.5 : 0,
            transform: isHovered ? "translate(-1.5px, -0.5px)" : "translate(0, 0)",
            transition: isHovered ? "all 0.25s ease-in-out" : "all 0.3s ease 0.2s",
          }}
        >
          <path
            d={notePath}
            stroke="#00f7f7"
            strokeWidth="2.5"
            strokeLinecap="round"
            strokeLinejoin="round"
            fill="none"
          />
          <path d={wavePath} stroke="#00f7f7" strokeWidth="2.5" strokeLinecap="round" fill="none" />
        </g>
        <g
          style={{
            opacity: isHovered ? 0.5 : 0,
            transform: isHovered ? "translate(1.5px, 0.5px)" : "translate(0, 0)",
            transition: isHovered ? "all 0.25s ease-in-out 0.05s" : "all 0.3s ease 0.15s",
          }}
        >
          <path
            d={notePath}
            stroke="#ff2d55"
            strokeWidth="2.5"
            strokeLinecap="round"
            strokeLinejoin="round"
            fill="none"
          />
          <path d={wavePath} stroke="#ff2d55" strokeWidth="2.5" strokeLinecap="round" fill="none" />
        </g>
        <g
          style={{
            transform: isHovered ? "scale(1.05)" : "scale(1)",
            transformOrigin: "24px 24px",
            transition: "transform 0.3s ease-in-out",
          }}
        >
          <path
            d={notePath}
            stroke={backgroundTheme === 'light' ? '#94A3B8' : '#94A3B8'}
            strokeWidth="2.5"
            strokeLinecap="round"
            strokeLinejoin="round"
            fill="none"
          />
          <path d={wavePath} stroke={backgroundTheme === 'light' ? '#94A3B8' : '#94A3B8'} strokeWidth="2.5" strokeLinecap="round" fill="none" />
        </g>
      </svg>
    </div>
  );
}

function InstagramIconAnimated({ isHovered, backgroundTheme }: { isHovered: boolean; backgroundTheme?: 'light' | 'grey' | 'dark' }) {
  return (
    <div className="cursor-pointer flex items-center justify-center">
      <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 sm:w-6 sm:h-6">
        <defs>
          <linearGradient id="igGradient" x1="0%" y1="100%" x2="100%" y2="0%">
            <stop offset="0%" stopColor="#feda75" />
            <stop offset="25%" stopColor="#fa7e1e" />
            <stop offset="50%" stopColor="#d62976" />
            <stop offset="75%" stopColor="#962fbf" />
            <stop offset="100%" stopColor="#4f5bd5" />
          </linearGradient>
        </defs>
        <rect 
          x="10" 
          y="10" 
          width="28" 
          height="28" 
          rx="8" 
          stroke={isHovered ? "url(#igGradient)" : (backgroundTheme === 'light' ? '#94A3B8' : '#94A3B8')}
          strokeWidth="2.5" 
          fill="none"
          style={{
            transition: "stroke 0.3s ease-in-out",
          }}
        />
        <circle
          cx="24"
          cy="24"
          r="7"
          stroke={isHovered ? "url(#igGradient)" : (backgroundTheme === 'light' ? '#94A3B8' : '#94A3B8')}
          strokeWidth="2.5"
          fill="none"
          style={{
            transform: isHovered ? "scale(1.1)" : "scale(1)",
            transformOrigin: "24px 24px",
            transition: "transform 0.3s ease-in-out, stroke 0.3s ease-in-out",
          }}
        />
        <circle
          cx="32"
          cy="16"
          r="2"
          fill={backgroundTheme === 'light' ? '#94A3B8' : '#94A3B8'}
          style={{
            opacity: isHovered ? 1 : 0.6,
            transition: "opacity 0.3s ease-in-out",
          }}
        />
      </svg>
    </div>
  );
}

type SettingsSection = 'personal' | 'accounts' | 'payout' | 'notifications';

interface CampaignData {
  id: string;
  name: string;
  avatar?: string;
  timeAgo: string;
  title: string;
  description: string;
  status: 'Active' | 'Ended' | 'Coming Soon';
  endsIn: string;
  paidOutPercent?: string;
  language: string;
  platforms: ('instagram' | 'tiktok' | 'youtube')[];
  payType: string;
  payout: string;
  rules: string[];
  requiredHashtags?: string[];
}

const CAMPAIGNS: CampaignData[] = [
  {
    id: 'fighter-music',
    name: 'Fighter Music',
    timeAgo: '13d ago',
    title: 'Turn Pain into Power',
    description: 'Fighter Music is a passionate artist turning pain into power, and scars into sound. Create clips showcasing their music and earn your share of the budget!',
    status: 'Active',
    endsIn: '6d',
    paidOutPercent: '87.37%',
    language: 'English',
    platforms: ['instagram', 'tiktok', 'youtube'],
    payType: 'Per view',
    payout: '$1.00 cpm',
    rules: [
      'Allowed Content: Use footage from provided music videos only. No unrelated footage or outside content.',
      'Minimum video length: 15 seconds',
      'Must include audio from the official track',
      'No explicit or inappropriate content'
    ],
    requiredHashtags: ['#FighterMusic', '#ElevateMusic']
  },
  {
    id: 'asta-violina',
    name: 'Asta Violina',
    timeAgo: '13d ago',
    title: 'Classical Meets Modern',
    description: 'Asta Violina brings classical violin to the modern age. Create engaging content featuring their unique sound and earn from every view!',
    status: 'Active',
    endsIn: '10d',
    paidOutPercent: '45.20%',
    language: 'English',
    platforms: ['instagram', 'tiktok', 'youtube'],
    payType: 'Per view',
    payout: '$0.80 cpm',
    rules: [
      'Allowed Content: Use footage from provided music videos only.',
      'Minimum video length: 10 seconds',
      'Must include audio from the official track',
      'Family-friendly content only'
    ],
    requiredHashtags: ['#AstaViolina', '#ClassicalVibes']
  }
];

const COUNTRIES = [
  'United States',
  'United Kingdom',
  'Canada',
  'Australia',
  'Germany',
  'France',
  'Spain',
  'Italy',
  'Japan',
  'South Korea',
  'Brazil',
  'Mexico',
  'India',
  'China',
  'Netherlands',
  'Sweden',
  'Norway',
  'Denmark',
  'Finland',
  'Switzerland',
  'Austria',
  'Belgium',
  'Portugal',
  'Poland',
  'Greece',
  'Ireland',
  'New Zealand',
  'Singapore',
  'South Africa',
  'Argentina',
  'Chile',
  'Colombia',
  'Peru',
  'Thailand',
  'Vietnam',
  'Malaysia',
  'Indonesia',
  'Philippines',
  'Turkey',
  'United Arab Emirates',
  'Saudi Arabia',
  'Israel',
  'Egypt',
  'Nigeria',
  'Kenya',
  'Other'
];

const LANGUAGES = [
  'English',
  'Spanish',
  'French',
  'German',
  'Italian',
  'Portuguese',
  'Dutch',
  'Russian',
  'Chinese (Mandarin)',
  'Japanese',
  'Korean',
  'Arabic',
  'Hindi',
  'Bengali',
  'Turkish',
  'Vietnamese',
  'Thai',
  'Indonesian',
  'Malay',
  'Tagalog',
  'Swedish',
  'Norwegian',
  'Danish',
  'Finnish',
  'Polish',
  'Greek',
  'Hebrew',
  'Swahili',
  'Other'
];

export function ArtistDashboard() {
  const { theme: backgroundTheme, setTheme: setBackgroundTheme } = useTheme();
  const { profile: cachedProfile, userId: cachedUserId, updateProfile: updateCachedProfile, clearCache: clearProfileCache } = useUserProfile();
  const { conversations, refetch: refetchConversations } = useCustomerConversations(cachedUserId || '');
  const navigate = useNavigate();
  const location = useLocation();

  const [isDropdownOpen, setIsDropdownOpen] = useState(false);
  const [activeSection, setActiveSection] = useState('home');
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [earningsTab, setEarningsTab] = useState<'available' | 'pending' | 'paidout'>('available');
  const [isEditing, setIsEditing] = useState(false);
  const [userProfile, setUserProfile] = useState<any>(null);
  const [selectedCampaign, setSelectedCampaign] = useState<CampaignData | null>(null);
  const [userType, setUserType] = useState<string>('');
  const [profilePicture, setProfilePicture] = useState<File | null>(null);
  const [profilePicturePreview, setProfilePicturePreview] = useState<string | null>(null);
  const [isSaving, setIsSaving] = useState(false);
  const [saveError, setSaveError] = useState<string | null>(null);
  const [isTipaltiConnected, setIsTipaltiConnected] = useState(false);
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    username: '',
    bio: '',
    language: '',
    email: ''
  });
  const [currentUserId, setCurrentUserId] = useState<string>('');
  const [showFeedbackModal, setShowFeedbackModal] = useState(false);
  const [emailNewFeatures, setEmailNewFeatures] = useState<boolean>(true);
  const [emailPlatformUpdates, setEmailPlatformUpdates] = useState<boolean>(true);
  const [isSavingNotifications, setIsSavingNotifications] = useState(false);
  const [feedbackCategory, setFeedbackCategory] = useState<'suggestion' | 'bug-report' | 'feature-request' | 'other' | null>(null);
  const [selectedLanguage, setSelectedLanguage] = useState<string>('English');
  const [isLanguageDropdownOpen, setIsLanguageDropdownOpen] = useState(false);
  const [cachedProfilePic, setCachedProfilePic] = useState<string | null>(null);
  const dropdownRef = useRef<HTMLDivElement>(null);
  const languageDropdownRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const personalRef = useRef<HTMLDivElement>(null);
  const accountsRef = useRef<HTMLDivElement>(null);
  const payoutRef = useRef<HTMLDivElement>(null);

  const unreadCount = useMemo(() => {
    if (!currentUserId || conversations.length === 0) return 0;
    const total = conversations.reduce((sum, conv) => {
      const unread = conv.customer_id === currentUserId
        ? (conv.unread_count_customer || 0)
        : (conv.unread_count_admin || 0);
      return sum + unread;
    }, 0);
    return total;
  }, [currentUserId, conversations]);

  const shouldShowBadge = activeSection !== 'messages' && unreadCount > 0;

  useEffect(() => {
    console.log('ðŸ·ï¸ [ArtistDashboard] Badge Debug:', {
      currentUserId,
      conversationsCount: conversations.length,
      unreadCount,
      activeSection,
      shouldShowBadge,
      conversations: conversations.map(c => ({
        id: c.id,
        customer_id: c.customer_id,
        unread_count_customer: c.unread_count_customer,
        unread_count_admin: c.unread_count_admin,
        effectiveUnread: c.customer_id === currentUserId ? c.unread_count_customer : c.unread_count_admin,
        last_message: c.last_message?.substring(0, 30)
      }))
    });
  }, [currentUserId, conversations, unreadCount, activeSection, shouldShowBadge]);

  useEffect(() => {
    if (cachedProfile && !userProfile) {
      console.log('[ArtistDashboard] ðŸš€ INSTANT: Loading from cached profile');
      setUserProfile(cachedProfile);
      setUserType('ARTIST');
      if (cachedUserId) {
        setCurrentUserId(cachedUserId);
      }
      setFormData({
        firstName: cachedProfile.first_name || '',
        lastName: cachedProfile.last_name || '',
        username: cachedProfile.username || '',
        bio: '',
        location: cachedProfile.location || '',
        language: cachedProfile.primary_language || '',
        email: cachedProfile.email || ''
      });
      if (cachedProfile.profile_picture_url) {
        setProfilePicturePreview(cachedProfile.profile_picture_url);
      }
    }
  }, [cachedProfile, cachedUserId, userProfile]);

  useEffect(() => {
    localStorage.setItem('currentDashboard', '/dashboard/artist');
    if (!cachedProfile) {
      fetchUserProfile();
    }
  }, [cachedProfile]);

  useEffect(() => {
    if (userProfile?.profile_picture_url && !userProfile.profile_picture_url.startsWith('blob:')) {
      const cachedImage = getCachedImage(userProfile.profile_picture_url);
      if (cachedImage && cachedImage !== cachedProfilePic) {
        setCachedProfilePic(cachedImage);
      } else if (!cachedImage) {
        const timeoutId = setTimeout(() => {
          const newlyCached = getCachedImage(userProfile.profile_picture_url);
          if (newlyCached) {
            setCachedProfilePic(newlyCached);
          }
        }, 500);
        return () => clearTimeout(timeoutId);
      }
    } else {
      setCachedProfilePic(null);
    }
  }, [userProfile?.profile_picture_url, cachedProfilePic]);

  useEffect(() => {
    if (currentUserId && activeSection !== 'messages') {
      const timeoutId = setTimeout(() => {
        refetchConversations();
      }, 100);
      return () => clearTimeout(timeoutId);
    }
  }, [activeSection, currentUserId, refetchConversations]);

  useEffect(() => {
    const handleVisibilityChange = () => {
      if (!document.hidden) {
        fetchUserProfile();
      }
    };
    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
  }, []);

  const fetchUserProfile = async () => {
    try {
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      const verifiedUserId = localStorage.getItem('verifiedUserId');
      const verifiedEmail = localStorage.getItem('verifiedEmail');
      let userId = user?.id || verifiedUserId;

      console.log('ðŸ” User ID resolution:', {
        'auth user id': user?.id,
        'verifiedUserId from localStorage': verifiedUserId,
        'verifiedEmail from localStorage': verifiedEmail,
        'final userId': userId
      });

      if (!userId) {
        console.warn('âŒ No user ID found. Auth error:', authError);
        console.warn('Verified email:', verifiedEmail);
        return;
      }

      console.log('ðŸ“¥ Fetching profile for userId:', userId);
      console.log('Auth user:', user?.id);
      console.log('Is authenticated:', !!user);

      let profile = null;
      let userData = null;

      try {
        console.log('Attempting to fetch via Edge Function...');
        const fetchUrl = `${SUPABASE_URL}/functions/v1/get-profile?userId=${userId}`;
        console.log('Edge Function URL:', fetchUrl);

        const fetchResponse = await fetch(fetchUrl, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
          },
        });

        console.log('Edge Function response status:', fetchResponse.status);
        console.log('Edge Function response headers:', Object.fromEntries(fetchResponse.headers.entries()));

        const contentType = fetchResponse.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const textResponse = await fetchResponse.text();
          console.warn('âš ï¸ Edge Function returned non-JSON response (likely HTML error page)');
          console.warn('Response preview:', textResponse.substring(0, 200));
          console.warn('This usually means the Edge Function does not exist or is misconfigured');
        } else if (fetchResponse.ok) {
          const fetchData = await fetchResponse.json();
          console.log('âœ… Edge Function response data:', fetchData);

          if (fetchData.success) {
            profile = fetchData.profile;
            userData = fetchData.user;
            console.log('âœ… Successfully fetched via Edge Function');
            console.log('Profile:', profile);
            console.log('User:', userData);
            console.log('Profile picture URL from database:', profile?.profile_picture_url || userData?.profile_picture_url);
            console.log('All profile keys:', profile ? Object.keys(profile) : 'null');
          } else {
            console.warn('âš ï¸ Edge Function returned success:false', fetchData.message);
          }
        } else {
          const errorText = await fetchResponse.text();
          console.error('âŒ Edge Function fetch failed:', fetchResponse.status, errorText.substring(0, 200));
        }
      } catch (fetchErr) {
        console.error('âŒ Error fetching via Edge Function:', fetchErr);
      }

      if (!profile) {
        console.log('ðŸ” Edge Function didn\'t return data, trying direct query...');
        console.log('Querying users table for userId:', userId);

        const userResult = await supabase
          .from('users')
          .select('*')
          .eq('id', userId)
          .maybeSingle();

        if (!userResult.data && !userResult.error) {
          const verifiedEmail = localStorage.getItem('verifiedEmail');
          if (verifiedEmail) {
            console.log('ðŸ” User not found by ID, trying email:', verifiedEmail);
            const emailResult = await supabase
              .from('users')
              .select('*')
              .eq('email', verifiedEmail)
              .maybeSingle();

            if (emailResult.data) {
              console.log('âœ… Found user by email:', emailResult.data);
              console.log('ðŸ“¦ Username from users table:', emailResult.data.username);
              userResult.data = emailResult.data;
            } else {
              console.warn('âš ï¸ User not found by email either');
              console.warn('Query result:', emailResult);
            }
          }
        }

        console.log('ðŸ“Š Users table query result:', {
          hasData: !!userResult.data,
          hasError: !!userResult.error,
          data: userResult.data,
          error: userResult.error
        });

        if (userResult.error) {
          console.error('âŒ Error fetching users table:', userResult.error);
          console.error('Error details:', {
            message: userResult.error.message,
            details: userResult.error.details,
            hint: userResult.error.hint,
            code: userResult.error.code
          });
        } else {
          console.log('âœ… users table query successful');
          if (userResult.data) {
            console.log('ðŸ“¦ User data found:', Object.keys(userResult.data));
            profile = userResult.data;
            userData = userResult.data;
          } else {
            console.warn('âš ï¸ users table query returned no data (null)');
            console.warn('Trying profiles table as fallback...');

            const profileResult = await supabase
              .from('profiles')
              .select('*')
              .eq('id', userId)
              .maybeSingle();

            console.log('ðŸ“Š Profiles table query result:', {
              hasData: !!profileResult.data,
              hasError: !!profileResult.error,
              data: profileResult.data,
              error: profileResult.error
            });

            if (profileResult.error) {
              console.error('âŒ Error fetching profiles table:', profileResult.error);
            } else if (profileResult.data) {
              console.log('âœ… Found user in profiles table');
              const profileData = profileResult.data;

              const nameParts = profileData.name ? profileData.name.split(' ') : [];
              const mappedProfile = {
                ...profileData,
                first_name: nameParts[0] || '',
                last_name: nameParts.slice(1).join(' ') || '',
                username: profileData.name || '',
                profile_picture_url: profileData.avatar_url || '',
                name: profileData.name,
                avatar_url: profileData.avatar_url,
              };

              console.log('ðŸ“¦ Mapped profile data:', mappedProfile);
              profile = mappedProfile;
              userData = mappedProfile;
            } else {
              console.warn('âš ï¸ User not found in either users or profiles table');
              console.warn('This could mean:');
              console.warn('1. User does not exist in database');
              console.warn('2. RLS policy is blocking access');
              console.warn('3. userId mismatch');
            }
          }
        }
      }

      console.log('Final profile data:', profile);
      console.log('Final user data:', userData);

      const profileData = userData || profile;
      const profilePicUrl = profileData?.profile_picture_url || profileData?.avatar_url;

      if (profilePicUrl && !profilePicUrl.startsWith('blob:')) {
        const cachedImage = getCachedImage(profilePicUrl);
        if (cachedImage) {
          setCachedProfilePic(cachedImage);
        } else {
          preloadAndCacheImage(profilePicUrl);
        }
      }

      setUserProfile(profileData);
      setUserType('ARTIST');

      const formDataToSet = {
        firstName: profileData?.first_name || '',
        lastName: profileData?.last_name || '',
        username: profileData?.username || '',
        bio: profileData?.bio || '',
        language: profileData?.primary_language || '',
        email: profileData?.email || user?.email || verifiedEmail || ''
      };

      console.log('Setting form data from users table:', formDataToSet);
      setFormData(formDataToSet);

      if (profilePicturePreview && profilePicturePreview.startsWith('blob:')) {
        URL.revokeObjectURL(profilePicturePreview);
        setProfilePicturePreview(null);
      }

      const picUrl = profileData?.profile_picture_url || profileData?.avatar_url;
      if (picUrl && !picUrl.startsWith('blob:')) {
        setProfilePicturePreview(picUrl);
      } else {
        setProfilePicturePreview(null);
      }

      if (profileData) {
        console.log('âœ… Profile synced successfully from users table:', {
          firstName: profileData?.first_name,
          lastName: profileData?.last_name,
          username: profileData?.username,
          location: profileData?.location,
          language: profileData?.primary_language,
          userType: profileData?.user_type,
          profilePicture: !!profileData?.profile_picture_url,
          email: profileData?.email
        });
        console.log('Form data has been set. Check if fields are displaying...');

        setEmailNewFeatures(profileData?.email_new_features ?? true);
        setEmailPlatformUpdates(profileData?.email_platform_updates ?? true);
      } else {
        console.warn('âŒ No user data found for userId:', userId);
        console.warn('This might mean the user completed OTP but not onboarding');
        console.warn('Form data set with empty values - user needs to complete onboarding');
      }
    } catch (err) {
      console.error('Error in fetchUserProfile:', err);
    }
  };

  
  const handleProfilePictureClick = () => {
    fileInputRef.current?.click();
  };

  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file) {
      setProfilePicture(file);
      const url = URL.createObjectURL(file);
      setProfilePicturePreview(url);
    }
  };

  const handleSaveChanges = async () => {
    setIsSaving(true);
    setSaveError(null);

    try {
      const userId = currentUserId || localStorage.getItem('verifiedUserId');

      if (!userId) {
        setSaveError('You must be logged in to save changes');
        setIsSaving(false);
        return;
      }

      let profilePictureBase64 = null;
      let profilePictureFileName = null;

      if (profilePicture) {
        try {
          const reader = new FileReader();
          profilePictureBase64 = await new Promise<string>((resolve, reject) => {
            reader.onload = () => {
              const result = reader.result as string;
              const base64 = result.split(',')[1];
              resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(profilePicture);
          });
          profilePictureFileName = profilePicture.name;
        } catch (convertErr) {
          setSaveError('Failed to process profile picture');
          setIsSaving(false);
          return;
        }
      }

      const apiUrl = `${SUPABASE_URL}/functions/v1/save-profile`;
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: userId,
          firstName: formData.firstName,
          lastName: formData.lastName,
          bio: formData.bio,
          primaryLanguage: formData.language,
          profilePictureBase64,
          profilePictureFileName,
        }),
      });

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.message || 'Failed to save changes');
      }

      updateCachedProfile({
        first_name: formData.firstName,
        last_name: formData.lastName,
        primary_language: formData.language,
        profile_picture_url: data.profilePictureUrl || userProfile?.profile_picture_url || null,
      });

      setUserProfile((prev: any) => prev ? {
        ...prev,
        first_name: formData.firstName,
        last_name: formData.lastName,
        bio: formData.bio,
        primary_language: formData.language,
        profile_picture_url: data.profilePictureUrl || prev.profile_picture_url,
      } : null);

      setProfilePicture(null);
      setProfilePicturePreview(null);
      setIsEditing(false);
    } catch (err) {
      console.error('Error saving profile:', err);
      setSaveError(err.message || 'Failed to save changes');
    } finally {
      setIsSaving(false);
    }
  };

  const handleUpdateProfile = async (updates: { profile_picture?: File; banner?: File; bio?: string }) => {
    if (!currentUserId) return;

    try {
      console.log('ðŸ“ Updating profile with:', updates);

      let profilePictureBase64 = null;
      let profilePictureFileName = null;
      let bannerBase64 = null;
      let bannerFileName = null;

      if (updates.profile_picture) {
        console.log('ðŸ–¼ï¸ Converting profile picture to base64...');
        const file = updates.profile_picture;
        const reader = new FileReader();
        profilePictureBase64 = await new Promise((resolve, reject) => {
          reader.onload = () => {
            const result = reader.result as string;
            const base64 = result.split(',')[1];
            resolve(base64);
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        profilePictureFileName = file.name;
      }

      if (updates.banner) {
        console.log('ðŸ–¼ï¸ Converting banner to base64...');
        const file = updates.banner;
        const reader = new FileReader();
        bannerBase64 = await new Promise((resolve, reject) => {
          reader.onload = () => {
            const result = reader.result as string;
            const base64 = result.split(',')[1];
            resolve(base64);
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        bannerFileName = file.name;
      }

      const response = await fetch(
        `${SUPABASE_URL}/functions/v1/save-profile`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({
            userId: currentUserId,
            profilePictureBase64,
            profilePictureFileName,
            bannerBase64,
            bannerFileName,
            bio: updates.bio,
          }),
        }
      );

      const data = await response.json();

      console.log('ðŸ” Response status:', response.status);
      console.log('ðŸ” Response data:', data);

      if (!response.ok || !data.success) {
        const errorMessage = data.message || data.error || 'Failed to update profile';
        console.error('âŒ Profile update failed:', errorMessage);
        throw new Error(errorMessage);
      }

      console.log('âœ… Profile updated successfully');

      await fetchUserProfile();
    } catch (err) {
      console.error('âŒ Error updating profile:', err);
      throw err;
    }
  };

  
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsDropdownOpen(false);
      }
      if (languageDropdownRef.current && !languageDropdownRef.current.contains(event.target as Node)) {
        setIsLanguageDropdownOpen(false);
      }
    };

    if (isDropdownOpen || isLanguageDropdownOpen) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [isDropdownOpen, isLanguageDropdownOpen]);

  const renderPersonalInfo = () => (
    <div ref={personalRef} className="scroll-mt-6 space-y-3 lg:space-y-4">
      {/* ... */}
    </div>
  );

  const renderConnectedAccounts = () => (
    <div ref={accountsRef} className="scroll-mt-6">
      <SocialLinksForm appliedTheme={backgroundTheme} userType="artist" />
    </div>
  );

  const renderPayoutMethods = () => (
    <div ref={payoutRef} className="scroll-mt-6">
      {/* ... */}
    </div>
  );

  const handleToggleNewFeatures = async () => {
    const newValue = !emailNewFeatures;
    setEmailNewFeatures(newValue);
    await saveNotificationPreference('email_new_features', newValue);
  };

  const handleTogglePlatformUpdates = async () => {
    const newValue = !emailPlatformUpdates;
    setEmailPlatformUpdates(newValue);
    await saveNotificationPreference('email_platform_updates', newValue);
  };

  const saveNotificationPreference = async (field: 'email_new_features' | 'email_platform_updates', value: boolean) => {
    if (!currentUserId) return;

    setIsSavingNotifications(true);
    try {
      const { error } = await supabase
        .from('users')
        .update({ [field]: value })
        .eq('id', currentUserId);

      if (error) {
        console.error('Error saving notification preference:', error);
        if (field === 'email_new_features') {
          setEmailNewFeatures(!value);
        } else {
          setEmailPlatformUpdates(!value);
        }
      }
    } catch (err) {
      console.error('Error saving notification preference:', err);
      if (field === 'email_new_features') {
        setEmailNewFeatures(!value);
      } else {
        setEmailPlatformUpdates(!value);
      }
    } finally {
      setIsSavingNotifications(false);
    }
  };

  const renderNotifications = () => (
    <div className="scroll-mt-6">
      {/* ... */}
    </div>
  );

  const renderSendFeedback = () => (
    <div className="scroll-mt-6">
      {/* ... */}
    </div>
  );

  const renderGuides = () => (
    <div className="scroll-mt-6 px-4 lg:px-6 py-6">
      {/* ... */}
    </div>
  );

  const renderLogOut = () => (
    <div className="scroll-mt-6 flex gap-3">
      {/* ... */}
    </div>
  );

  const renderDisplay = () => (
    <div className="scroll-mt-6">
      {/* ... */}
    </div>
  );

  const renderLanguages = () => (
    <div className="scroll-mt-6">
      {/* ... */}
    </div>
  );

  const getPreviewTextColor = () => {
    switch (backgroundTheme) {
      case 'light':
        return '#FFFFFF';
      case 'grey':
      case 'dark':
      default:
        return '#F8FAFC';
    }
  };

  const getPreviewBackground = () => {
    switch (backgroundTheme) {
      case 'light':
        return '#0F172A';
      case 'grey':
        return '#1A1A1E';
      case 'dark':
      default:
        return '#000000';
    }
  };

  const languageOptions = [
    'English',
    'Spanish',
    'French',
    'German',
    'Italian',
    'Portuguese',
    'Dutch',
    'Russian',
    'Chinese (Mandarin)',
    'Japanese',
    'Korean',
    'Arabic',
    'Hindi',
    'Bengali',
    'Turkish',
    'Vietnamese',
    'Thai',
    'Indonesian',
    'Malay',
    'Tagalog',
    'Swedish',
    'Norwegian',
    'Danish',
    'Finnish',
    'Polish',
    'Greek',
    'Hebrew',
    'Swahili',
    'Other'
  ];

  return (
    <div className="min-h-screen flex">
      <CollapsibleSidebar
        activeSection={activeSection}
        setActiveSection={setActiveSection}
        userType={userType}
        collapsed={sidebarCollapsed}
        onToggleCollapse={() => setSidebarCollapsed(!sidebarCollapsed)}
        unreadCount={unreadCount}
      />

      {/* Main Content */}
      <div className="flex-1 flex flex-col" style={{ backgroundColor: 'var(--bg-primary)' }}>
        {/* Header */}
        <div className="sticky top-0 z-40 px-4 sm:px-6 lg:px-8 py-4 border-b" style={{ borderColor: 'var(--border-subtle)', backgroundColor: 'var(--bg-primary)' }}>
          <div className="flex items-center justify-between max-w-7xl mx-auto">
            <div>
              <h1 className="text-xl sm:text-2xl font-bold" style={{ color: 'var(--text-primary)' }}>Artist Dashboard</h1>
              <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>Manage your music career</p>
            </div>
            <div className="flex items-center gap-3">
              <button
                onClick={() => setShowFeedbackModal(true)}
                className="p-2 rounded-lg transition-all hover:brightness-110"
                style={{ backgroundColor: 'var(--bg-elevated)' }}
              >
                <MessageSquare className="w-5 h-5" style={{ color: 'var(--text-secondary)' }} />
              </button>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {/* Home Section */}
            {activeSection === 'home' && (
              <div>
                <div>
                  <h3 className="text-sm lg:text-lg font-semibold mb-3 lg:mb-6" style={{ color: '#F8FAFC' }}>Preview</h3>
                  <div 
                    className="rounded-xl sm:rounded-2xl p-5 sm:p-7 border transition-all duration-300"
                    style={{ 
                      backgroundColor: getPreviewBackground(), 
                      borderColor: backgroundTheme === 'light' ? 'rgba(148, 163, 184, 0.3)' : '#2f2f2f' 
                    }}
                  >
                    <div className="flex items-center gap-4 mb-4">
                      <div 
                        className="w-10 h-10 rounded-full overflow-hidden"
                        style={{ 
                          backgroundColor: backgroundTheme === 'light' ? '#F3F4F6' : backgroundTheme === 'grey' ? '#2A2A2E' : '#2f2f2f',
                        }}
                      >
                        <img
                          src={ELEVATE_ADMIN_AVATAR_URL}
                          alt="Elevate"
                          className="w-full h-full object-cover"
                        />
                      </div>
                      <div className="flex-1 min-w-0 flex items-center">
                        <h4 className="font-semibold" style={{ color: getPreviewTextColor() }}>Elevate</h4>
                      </div>
                    </div>
                    
                    <div className="mb-4">
                      <p className="mb-3" style={{ color: getPreviewTextColor() }}>
                        Manage your music, revenue, and opportunities. Distribute with a purpose, monetize, and connect your music with brands, all in one place.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Background Selector */}
            <div>
            <h3 className="text-sm lg:text-lg font-semibold mb-3 lg:mb-6" style={{ color: '#F8FAFC' }}>Background Theme</h3>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
              {/* Light Option */}
              <div 
                className={`relative rounded-xl sm:rounded-2xl p-5 sm:p-7 border-2 cursor-pointer transition-all duration-200 ${
                  backgroundTheme === 'light' ? 'border-blue-500' : 'border-gray-600'
                }`}
                style={{ backgroundColor: '#0F172A' }}
                onClick={() => setBackgroundTheme('light')}
              >
                <div className="absolute top-4 right-4">
                  <div className={`w-5 h-5 rounded-full border-2 ${
                    backgroundTheme === 'light' 
                      ? 'bg-blue-500 border-blue-500' 
                      : 'bg-white border-gray-400'
                  }`}>
                    {backgroundTheme === 'light' && (
                      <div className="w-full h-full flex items-center justify-center">
                        <span className="text-white text-xs">âœ“</span>
                      </div>
                    )}
                  </div>
                </div>
                
                <div className="mb-4">
                  <div className="w-full h-20 rounded-lg bg-gray-700 mb-2"></div>
                  <div className="h-2 bg-gray-600 rounded w-3/4 mb-2"></div>
                  <div className="h-2 bg-gray-600 rounded w-1/2"></div>
                </div>
                
                <h4 className="font-semibold text-white mb-1">Navy</h4>
                <p className="text-sm text-gray-300">Navy blue background</p>
              </div>

              {/* Grey Option */}
              <div 
                className={`relative rounded-xl sm:rounded-2xl p-5 sm:p-7 border-2 cursor-pointer transition-all duration-200 ${
                  backgroundTheme === 'grey' ? 'border-blue-500' : 'border-gray-600'
                }`}
                style={{ backgroundColor: '#1A1A1E' }}
                onClick={() => setBackgroundTheme('grey')}
              >
                <div className="absolute top-4 right-4">
                  <div className={`w-5 h-5 rounded-full border-2 ${
                    backgroundTheme === 'grey' 
                      ? 'bg-blue-500 border-blue-500' 
                      : 'bg-white border-gray-400'
                  }`}>
                    {backgroundTheme === 'grey' && (
                      <div className="w-full h-full flex items-center justify-center">
                        <span className="text-white text-xs">âœ“</span>
                      </div>
                    )}
                  </div>
                </div>
                
                <div className="mb-4">
                  <div className="w-full h-20 rounded-lg bg-gray-800 mb-2"></div>
                  <div className="h-2 bg-gray-700 rounded w-3/4 mb-2"></div>
                  <div className="h-2 bg-gray-700 rounded w-1/2"></div>
                </div>
                
                <h4 className="font-semibold text-white mb-1">Grey</h4>
                <p className="text-sm text-gray-400">Dim background</p>
              </div>

              {/* Dark Option */}
              <div 
                className={`relative rounded-xl sm:rounded-2xl p-5 sm:p-7 border-2 cursor-pointer transition-all duration-200 ${
                  backgroundTheme === 'dark' ? 'border-blue-500' : 'border-gray-600'
                }`}
                style={{ backgroundColor: '#000000' }}
                onClick={() => setBackgroundTheme('dark')}
              >
                <div className="absolute top-4 right-4">
                  <div className={`w-5 h-5 rounded-full border-2 ${
                    backgroundTheme === 'dark' 
                      ? 'bg-blue-500 border-blue-500' 
                      : 'bg-white border-gray-400'
                  }`}>
                    {backgroundTheme === 'dark' && (
                      <div className="w-full h-full flex items-center justify-center">
                        <span className="text-white text-xs">âœ“</span>
                      </div>
                    )}
                  </div>
                </div>
                
                <div className="mb-4">
                  <div className="w-full h-20 rounded-lg bg-gray-900 mb-2"></div>
                  <div className="h-2 bg-gray-800 rounded w-3/4 mb-2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Mobile Bottom Navigation */}
      <MobileBottomNav
        activeSection={activeSection}
        setActiveSection={setActiveSection}
        userType={userType}
        unreadCount={unreadCount}
        profilePicture={profilePicturePreview}
      />
    </div>
  );
}
